<!DOCTYPE html>

<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <title>Sing and Harmonize!</title>
   <script src="/static/jquery-3.2.1.min.js"></script>
   <link rel="stylesheet" type="text/css" href="../static/bootstrap-3.3.7-dist/css/bootstrap.min.css">
   <script src="../static/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
   <script src="/static/dist/recorder.js"></script>
   <style type='text/css'>
      ul { list-style: none; }
      #recordingslist audio { display: block; margin-bottom: 10px; }
      * {
            -webkit-user-select: none;
         }
         body, html {
            margin: 0;
            height: 100%;
            position: relative;
         }
         body {
            padding-top: 70px;
            overflow: auto;
            background-color: lightblue;
         }
         h1 {
            text-align: center;
         }
         td {
            padding-top:5px;
            padding-bottom:5px;
            padding-right:10px;
         }
         li {
            text-align: center;
         }
         br {
            line-height: 150%;
         }
   </style>
</head>
<body>
   <div id="audio_list">
         <!-- audio tonic files -->
         <audio id="60Majorhigh.mp3" src="./resources/60Majorhigh.mp3" preload="auto"></audio>
         <audio id="60Majormid.mp3"  src="./resources/60Majormid.mp3" preload="auto"></audio>
         <audio id="60Minorhigh.mp3" src="./resources/60Minorhigh.mp3" preload="auto"></audio>
         <audio id="60Minormid.mp3"  src="./resources/60Minormid.mp3" preload="auto"></audio>

         <audio id="61Majorhigh.mp3" src="./resources/61Majorhigh.mp3" preload="auto"></audio>
         <audio id="61Majormid.mp3"  src="./resources/61Majormid.mp3" preload="auto"></audio>
         <audio id="61Minorhigh.mp3" src="./resources/61Minorhigh.mp3" preload="auto"></audio>
         <audio id="61Minormid.mp3"  src="./resources/61Minormid.mp3" preload="auto"></audio>

         <audio id="62Majorhigh.mp3" src="./resources/62Majorhigh.mp3" preload="auto"></audio>
         <audio id="62Majormid.mp3"  src="./resources/62Majormid.mp3" preload="auto"></audio>
         <audio id="62Minorhigh.mp3" src="./resources/62Minorhigh.mp3" preload="auto"></audio>
         <audio id="62Minormid.mp3"  src="./resources/62Minormid.mp3" preload="auto"></audio>

         <audio id="63Majorhigh.mp3" src="./resources/63Majorhigh.mp3" preload="auto"></audio>
         <audio id="63Majormid.mp3"  src="./resources/63Majormid.mp3" preload="auto"></audio>
         <audio id="63Majorlow.mp3"  src="./resources/63Majorlow.mp3" preload="auto"></audio>
         <audio id="63Minorhigh.mp3" src="./resources/63Minorhigh.mp3" preload="auto"></audio>
         <audio id="63Minormid.mp3"  src="./resources/63Minormid.mp3" preload="auto"></audio>
         <audio id="63Minorlow.mp3"  src="./resources/63Minorlow.mp3" preload="auto"></audio>

         <audio id="64Majorhigh.mp3" src="./resources/64Majorhigh.mp3" preload="auto"></audio>
         <audio id="64Majormid.mp3"  src="./resources/64Majormid.mp3" preload="auto"></audio>
         <audio id="64Majorlow.mp3"  src="./resources/64Majorlow.mp3" preload="auto"></audio>
         <audio id="64Minorhigh.mp3" src="./resources/64Minorhigh.mp3" preload="auto"></audio>
         <audio id="64Minormid.mp3"  src="./resources/64Minormid.mp3" preload="auto"></audio>
         <audio id="64Minorlow.mp3"  src="./resources/64Minorlow.mp3" preload="auto"></audio>

         <audio id="65Majorhigh.mp3" src="./resources/65Majorhigh.mp3" preload="auto"></audio>
         <audio id="65Majormid.mp3"  src="./resources/65Majormid.mp3" preload="auto"></audio>
         <audio id="65Majorlow.mp3"  src="./resources/65Majorlow.mp3" preload="auto"></audio>
         <audio id="65Minorhigh.mp3" src="./resources/65Minorhigh.mp3" preload="auto"></audio>
         <audio id="65Minormid.mp3"  src="./resources/65Minormid.mp3" preload="auto"></audio>
         <audio id="65Minorlow.mp3"  src="./resources/65Minorlow.mp3" preload="auto"></audio>

         <audio id="66Majorhigh.mp3" src="./resources/66Majorhigh.mp3" preload="auto"></audio>
         <audio id="66Majormid.mp3"  src="./resources/66Majormid.mp3" preload="auto"></audio>
         <audio id="66Majorlow.mp3"  src="./resources/66Majorlow.mp3" preload="auto"></audio>
         <audio id="66Minorhigh.mp3" src="./resources/66Minorhigh.mp3" preload="auto"></audio>
         <audio id="66Minormid.mp3"  src="./resources/66Minormid.mp3" preload="auto"></audio>
         <audio id="66Minorlow.mp3"  src="./resources/66Minorlow.mp3" preload="auto"></audio>

         <audio id="67Majorhigh.mp3" src="./resources/67Majorhigh.mp3" preload="auto"></audio>
         <audio id="67Majormid.mp3"  src="./resources/67Majormid.mp3" preload="auto"></audio>
         <audio id="67Majorlow.mp3"  src="./resources/67Majorlow.mp3" preload="auto"></audio>
         <audio id="67Minorhigh.mp3" src="./resources/67Minorhigh.mp3" preload="auto"></audio>
         <audio id="67Minormid.mp3"  src="./resources/67Minormid.mp3" preload="auto"></audio>
         <audio id="67Minorlow.mp3"  src="./resources/67Minorlow.mp3" preload="auto"></audio>

         <audio id="68Majorhigh.mp3" src="./resources/68Majorhigh.mp3" preload="auto"></audio>
         <audio id="68Majormid.mp3"  src="./resources/68Majormid.mp3" preload="auto"></audio>
         <audio id="68Majorlow.mp3"  src="./resources/68Majorlow.mp3" preload="auto"></audio>
         <audio id="68Minorhigh.mp3" src="./resources/68Minorhigh.mp3" preload="auto"></audio>
         <audio id="68Minormid.mp3"  src="./resources/68Minormid.mp3" preload="auto"></audio>
         <audio id="68Minorlow.mp3"  src="./resources/68Minorlow.mp3" preload="auto"></audio>

         <audio id="69Majorhigh.mp3" src="./resources/69Majorhigh.mp3" preload="auto"></audio>
         <audio id="69Majormid.mp3"  src="./resources/69Majormid.mp3" preload="auto"></audio>
         <audio id="69Majorlow.mp3"  src="./resources/69Majorlow.mp3" preload="auto"></audio>
         <audio id="69Minorhigh.mp3" src="./resources/69Minorhigh.mp3" preload="auto"></audio>
         <audio id="69Minormid.mp3"  src="./resources/69Minormid.mp3" preload="auto"></audio>
         <audio id="69Minorlow.mp3"  src="./resources/69Minorlow.mp3" preload="auto"></audio>

         <audio id="70Majorlow.mp3"  src="./resources/70Majorlow.mp3" preload="auto"></audio>
         <audio id="70Majormid.mp3"  src="./resources/70Majormid.mp3" preload="auto"></audio>
         <audio id="70Minorlow.mp3"  src="./resources/70Minorlow.mp3" preload="auto"></audio>
         <audio id="70Minormid.mp3"  src="./resources/70Minormid.mp3" preload="auto"></audio>

         <audio id="71Majorlow.mp3"  src="./resources/71Majorlow.mp3" preload="auto"></audio>
         <audio id="71Majormid.mp3"  src="./resources/71Majormid.mp3" preload="auto"></audio>
         <audio id="71Minorlow.mp3"  src="./resources/71Minorlow.mp3" preload="auto"></audio>
         <audio id="71Minormid.mp3"  src="./resources/71Minormid.mp3" preload="auto"></audio>
      </div>

   <nav class="navbar navbar-inverse navbar-fixed-top">
         <div class="navbar-header">
            <a href="#" class="navbar-brand"><span class="glyphicon glyphicon-music" aria-hidden="true"></span> HarmonizeMe</a>
         </div>
         <ul class="nav navbar-nav">
            <li><a href="#">Replacethis,formusictheory</a></li>
         </ul>
      </nav>


   <div class="container">
      <h1>Record and sing!</h1>

      <div class="jumbotron">
         <p style="font-size:14px; text-align:center;">Use a recent version of Google Chrome.<br>
                        Before you enable microphone input, plug in headphones or turn the volume down to avoid loud feedback!</p>
         <h3 style="text-align:center;">Instructions:</h3>
         <p style="font-size:16px; text-align:center;">
            Use the "Record" button to begin recording, and "Stop" to stop recording. <br>
            Check the recording that popped up below, to see if you are satisfied. <br>
            Press "Clear" to clear the buffer and re-start the process is needed. <br>
            Then, press "Harmonize", and play the next file that appears!
         </p> 

         <div id="recordingButtons" style="text-align:center">
            <button class="btn btn-info" onclick="startRecording(this);">Record</button>
            <button class="btn btn-info" onclick="stopRecording(this);" disabled>Stop</button>
            <button class="btn btn-info" onclick="clearRecorder(this);" style="margin-right:12px">Clear</button>
            <button class="btn btn-primary" onclick="harmonize(this);">Harmonize!!</button> <br><br>


            fordebuggingfornow: <button class="btn btn-info" onclick="printBufferData(this);">print buffer data</button>
                              <button class="btn btn-primary" onclick="postData(this);">sinwave!!</button> <br><br>

         </div>

         <br><br>
         <div id="replayKey" style="text-align:center">
            <p align="center">If you need to re-listen to your key, click the button below:</p>
            <button class="btn btn-success" type="button" onclick="playKey(this)">Replay key!</button>
            <button class="btn btn-success" type="button" onclick="stopKey(this)" disabled>Stop</button>
         </div>
      </div>
   </div>
   
   <h2>Recordings</h2>
   <ul id="recordingslist"></ul>
   
   <h2>Log</h2>
   <pre id="log"></pre>

   <script>
   function __log(e, data) {
      log.innerHTML += "\n" + e + " " + (data || '');
   }

   var audio_context;
   var recorder;
   var bufferData;
   var tonic;
   var mode;
   var curr_audio;

   function startUserMedia(stream) {
      var input = audio_context.createMediaStreamSource(stream);
      __log('Media stream created.');

      // Uncomment if you want the audio to feedback directly
      //input.connect(audio_context.destination);
      //__log('Input connected to audio context destination.');
      
      recorder = new Recorder(input);
      __log('Recorder initialised.');
   }

   function startRecording(button) {
      recorder && recorder.record();
      button.disabled = true;
      button.nextElementSibling.disabled = false;
      __log('Recording...');
   }

   function stopRecording(button) {
      recorder && recorder.stop();
      button.disabled = true;
      button.previousElementSibling.disabled = false;
      __log('Stopped recording.');
      
      // create WAV download link using audio data blob
      createDownloadLink();

      // get the buffer data:
      recorder.getBuffer(function(data) {
         bufferData = data;
      });

      // MOVED TO clearRecorder
      //recorder.clear();
   }

   function printBufferData(button) {
      console.log(bufferData);
   }

   function clearRecorder(button) {
      recorder.clear();
   }

   function postData(button) {
      //console.log(bufferData);
      strData = bufferData.toString();
      newData = ""
      $.post("/bufferData", strData, function(data) {
            newData = data;
            //console.log("\nNewdata?: " + newData);
            var newFloatData = new Float32Array(JSON.parse(newData));
            var newChannelData = [];
            newChannelData.push(newFloatData);

            //console.log("\nNew float data?: " + newChannelData);

            // clear before it gives it new data
            recorder.clear();
            
            recorder.setBuffer(newChannelData);

            createDownloadLink();
         });
   }

   function harmonize(button) {
      strData = bufferData.toString();
      newData = ""
      $.post("/harmonizeData", strData, function(data) {
            newData = data;
            //console.log("\nNewdata?: " + newData);
            var newFloatData = new Float32Array(JSON.parse(newData));
            var newChannelData = [];
            newChannelData.push(newFloatData);

            //console.log("\nNew float data?: " + newChannelData);

            // clear before it gives it new data
            recorder.clear();
            
            recorder.setBuffer(newChannelData);

            createDownloadLink();
         });
   }

   function createDownloadLink() {
      recorder && recorder.exportWAV(function(blob) {
         var url = URL.createObjectURL(blob);
         var li = document.createElement('li');
         var au = document.createElement('audio');
         var hf = document.createElement('a');
         
         au.controls = true;
         au.src = url;
         hf.href = url;
         hf.download = new Date().toISOString() + '.wav';
         hf.innerHTML = hf.download;
         li.appendChild(au);
         li.appendChild(hf);
         recordingslist.appendChild(li);
      });
   }

   function playKey(button) {
      button.disabled = true;
      button.nextElementSibling.disabled = false;

      var mode_string = "Major";
      if (mode === 1) {
         mode_string = "Minor";
      }
      var file_name = tonic.toString() + mode_string + "mid.mp3";
      var html_audio = document.getElementById(file_name);

      if (curr_audio != null) { // not null, something is playing
         curr_audio.pause();
         curr_audio.currentTime = 0;
         curr_audio = html_audio;
         curr_audio.play()
         curr_audio.onended = function() {
            curr_audio = null;
         };
      }
      else { // nothing is playing
            curr_audio = html_audio;
            curr_audio.play();
            curr_audio.onended = function() {
               curr_audio = null;
         };
      }
   }

   function stopKey(button) {
      button.disabled = true;
      button.previousElementSibling.disabled = false;
      if (curr_audio != null) {
         curr_audio.pause();
         curr_audio.currentTime = 0;
         curr_audio = null;
      }
   }

   window.onload = function init() {
      $.get("/keyData", function(data) {
         var return_data = data.split(',');
         tonic = parseInt(return_data[0]);
         mode = parseInt(return_data[1]);
      });


      try {
         // webkit shim
         window.AudioContext = window.AudioContext || window.webkitAudioContext;
         navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
         window.URL = window.URL || window.webkitURL;
         
         audio_context = new AudioContext;
         __log('Audio context set up.');
         __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
      } catch (e) {
         alert('No web audio support in this browser!');
      }
      
      navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
         __log('No live audio input: ' + e);
      });
   };
   </script>


</body>
</html>
